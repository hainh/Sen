<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Document</title>
</head>
<body>
	<script src="msgpack.js"></script>
	<script>
		this.Sen = {
			throwOnDataError: false,
			Logger: console
		}
		this.MessageTypes = {
		  "types": [
		    {
		      "className": "MyData",
		      "unionCode": 1,
		      "values": [
		        {
		          "valueName": "A",
		          "keyCode": 0,
		          "type": "Int32",
		          "isArray": false
		        },
		        {
		          "valueName": "B",
		          "keyCode": 1,
		          "type": "String",
		          "isArray": false
		        },
		        {
		          "valueName": "C",
		          "keyCode": 2,
		          "type": "Int16",
		          "isArray": false
		        }
		      ]
		    },
		    {
		      "className": "MyData2",
		      "unionCode": 2,
		      "values": [
		        {
		          "valueName": "A",
		          "keyCode": 0,
		          "type": "Boolean",
		          "isArray": false
		        },
		        {
		          "valueName": "B",
		          "keyCode": 1,
		          "type": "Byte",
		          "isArray": false
		        },
		        {
		          "valueName": "C",
		          "keyCode": 2,
		          "type": "SByte",
		          "isArray": false
		        },
		        {
		          "valueName": "D",
		          "keyCode": 3,
		          "type": "Char",
		          "isArray": false
		        },
		        {
		          "valueName": "G",
		          "keyCode": 5,
		          "type": "Single",
		          "isArray": false
		        },
		        {
		          "valueName": "H",
		          "keyCode": 6,
		          "type": "Int32",
		          "isArray": false
		        },
		        {
		          "valueName": "I",
		          "keyCode": 7,
		          "type": "UInt32",
		          "isArray": false
		        },
		        {
		          "valueName": "J",
		          "keyCode": 8,
		          "type": "Int64",
		          "isArray": false
		        },
		        {
		          "valueName": "K",
		          "keyCode": 9,
		          "type": "UInt64",
		          "isArray": false
		        },
		        {
		          "valueName": "L",
		          "keyCode": 10,
		          "type": "Int16",
		          "isArray": false
		        },
		        {
		          "valueName": "M",
		          "keyCode": 11,
		          "type": "UInt16",
		          "isArray": false
		        },
		        {
		          "valueName": "N",
		          "keyCode": 12,
		          "type": "String",
		          "isArray": false
		        },
		        {
		          "valueName": "O",
		          "keyCode": 13,
		          "type": "Int32",
		          "isArray": false
		        },
		        {
		          "valueName": "AA",
		          "keyCode": 14,
		          "type": "Boolean",
		          "isArray": true
		        },
		        {
		          "valueName": "AB",
		          "keyCode": 15,
		          "type": "Byte",
		          "isArray": true
		        },
		        {
		          "valueName": "AC",
		          "keyCode": 16,
		          "type": "SByte",
		          "isArray": true
		        },
		        {
		          "valueName": "AD",
		          "keyCode": 17,
		          "type": "Char",
		          "isArray": true
		        },
		        {
		          "valueName": "AF",
		          "keyCode": 18,
		          "type": "Double",
		          "isArray": true
		        },
		        {
		          "valueName": "AG",
		          "keyCode": 19,
		          "type": "Single",
		          "isArray": true
		        },
		        {
		          "valueName": "AH",
		          "keyCode": 20,
		          "type": "Int32",
		          "isArray": true
		        },
		        {
		          "valueName": "AI",
		          "keyCode": 21,
		          "type": "UInt32",
		          "isArray": true
		        },
		        {
		          "valueName": "AJ",
		          "keyCode": 22,
		          "type": "Int64",
		          "isArray": true
		        },
		        {
		          "valueName": "AK",
		          "keyCode": 23,
		          "type": "UInt64",
		          "isArray": true
		        },
		        {
		          "valueName": "AL",
		          "keyCode": 24,
		          "type": "Int16",
		          "isArray": true
		        },
		        {
		          "valueName": "AM",
		          "keyCode": 25,
		          "type": "UInt16",
		          "isArray": true
		        },
		        {
		          "valueName": "AN",
		          "keyCode": 26,
		          "type": "String",
		          "isArray": true
		        },
		        {
		          "valueName": "MyData",
		          "keyCode": 27,
		          "type": "MyData",
		          "isArray": false
		        },
		        {
		          "valueName": "MyDatas",
		          "keyCode": 28,
		          "type": "MyData",
		          "isArray": true
		        }
		      ]
		    },
		    {
		      "className": "WiredData",
		      "unionCode": -1,
		      "values": [
		        {
		          "valueName": "ServiceCode",
		          "keyCode": 0,
		          "type": "Int32",
		          "isArray": false
		        },
		        {
		          "valueName": "Data",
		          "keyCode": 1,
		          "type": "TUnionDataInterface",
		          "isArray": false
		        }
		      ]
		    }
		  ]
		};
	</script>
	<script>
		(function processMessageTypes(MessageTypes) {
			var {types} = MessageTypes,
				typeDict = MessageTypes.__innerTypes__ = {},
				typeCodeDict = MessageTypes.__innerTypesByCode__ = {},
				type;
			for (var i = types.length - 1; i >= 0; i--) {
				type = types[i];
				typeDict[type['className']] = type;
				if (type['unionCode'] >= 0) {
					typeCodeDict[type['unionCode'] + ''] = type;
				}
				if (!type.values.find(value => value.type === 'Double')) {
					type.forceFloat32 = true;
				}
			}
			for (var i = types.length - 1; i >= 0; i--) {
				type = types[i];
				if (!type.values.find(value => value.type === 'Double' || (typeDict[value.type] && !typeDict[value.type].forceFloat32))) {
					type.forceFloat32 = true;
				}
			}
		})(MessageTypes);
		MessageTypes.createType = function() {
			for (var className in this.__innerTypes__) {
				eval(`var ctor = function ${className}(){if(!new.target)return new ${className}();}`);
				var dataType = this.__innerTypes__[className];
				this[className] = ctor;
				for (var i = 0; i < dataType['values'].length; i++) {
					var {valueName, keyCode, type, isArray} = dataType['values'][i];
					Object.defineProperty(ctor.prototype, valueName, defineGetterAndSetter(valueName, type, isArray, Sen.Logger));
				}
				ctor.prototype.toJSON = function() {
					var props = Object.getOwnPropertyDescriptors(this.constructor.prototype);
					var jsonObj = {};
					for (var propName in props) {
						if (typeof props[propName].get === 'function') {
							jsonObj[propName] = this[propName];
						}
					}
					return jsonObj;
				}
			}

			function defineGetterAndSetter(valueName, type, isArray, logger) {
				var minMax = {
					'Byte': [0, 0xFF],
					'SByte': [-0x7F, 0x7F],
					'Char': [0, 0xFFFF],
					'UInt16': [0, 0xFFFF],
					'Int16': [-0x7FFF, 0x7FFF],
					'UInt32': [0, 0xFFFFFFFF],
					'Int32': [-0x7FFFFFFF, 0x7FFFFFFF],
					'UInt64': [0, 0xFFFFFFFFFFFFFFFF],
					'Int64': [-0x7FFFFFFFFFFFFFFF, 0x7FFFFFFFFFFFFFFF],
					'Decimal': 1,
					'Single' : 1,
					'Double' : 1,
				};
				function buildElementValidator(valueName, type) {
					var range = minMax[type];
					if (range === 1) {
						return `if(isNaN(v)) {${Sen.throwOnDataError ? 'throw ' : 'logger.error'}(\`\${type} value of \${this.constructor.name}.${valueName} = \${v} is not a number\`)}`
					} else if (range.length === 2) {
						return `if (isNaN(v) || v - Math.floor(v)) {
								${Sen.throwOnDataError ? 'throw ' : 'logger.error'}(\`${type} value of \${this.constructor.name}.${valueName} = \${v} is not an integer\`);
							}
							else if (v < ${range[0]} || v > ${range[1]}) {
								${Sen.throwOnDataError ? 'throw ' : 'logger.error'}(\`${type} value of \${this.constructor.name}.${valueName} = \${v} is out of range (${range[0]}, ${range[1]})\`);
							}`;
					}
					return '';
				}
				function buildValidator(valueName, type, isArray) {
					var elementValidator = buildElementValidator(valueName, type);
					if (elementValidator) {
						return isArray
							? 'if (val) for (var i = val.length - 1; i >= 0; i--) \n{ var v = val[i];\n' + elementValidator + '\n}'
							: 'var v = val;\n' + elementValidator;
					}
					return '';
				}
				function buildSetter(valueName, type, isArray) {
					switch (type) {
						case 'Boolean': 
							return `function setter (val) { __rawData = ${isArray ? 'val && val.map(v => !!v)' : '!!val'};};`;
						case 'Byte':
						case 'SByte':
						case 'Char':
						case 'UInt16':
						case 'Int16':
						case 'UInt32':
						case 'Int32':
						case 'UInt64':
						case 'Int64':
						case 'Decimal':
						case 'Double':
						case 'Single':
							return `function setter (val){
								${buildValidator(valueName, type, isArray)}
								__rawData = ${isArray ? 'val && val.map(v => +v)' : '+val'};
							};`;
						case 'String':
							return `function setter (val) {
								__rawData = val && ${isArray ? 'val.map(v => v && v.toString())' : 'val.toString();'};
							};`;
						default:
							if (MessageTypes.__innerTypes__[type]) {
								return `function setter(val){
									if (val != null && val != undefined && ${isArray ? `val.find(v => !(v instanceof MessageTypes.${type}))` : `!(val instanceof MessageTypes.${type})`}) {
										${Sen.throwOnDataError ? 'throw ' : 'logger.error'}(\`Value of \${this.constructor.name}.${valueName} = \${JSON.stringify(val)} (\${val.constructor.name}) is not instanceof ${type}\`);
									}
									__rawData = val;
								};`
							} else {
								return `function setter(val) {__rawData = val;};`
							}
					}
				}
				var __rawData = null;
				var functionSetterScript = buildSetter(valueName, type, isArray);
				eval(functionSetterScript);
				var functionGetterScript = `function getter() {return __rawData};`;
				eval(functionGetterScript);
				return {
					get: getter,
					set: setter
				}
			}
		}
		MessageTypes.createType();
		var data = [146,44,146,2,220,0,29,195,0,0,0,192,202,0,0,0,0,0,0,0,0,0,0,192,1,192,192,192,192,192,192,192,192,192,192,192,192,192,147,206,0,1,226,64,165,55,56,57,49,48,208,133,145,147,206,0,1,226,64,165,55,56,57,49,48,208,133]
		var message = new Uint8Array(data);

		function parseData (buffer) {
			var obj = MessagePack.decode(buffer);
			var unionCode = obj[1][0];
			var unionType = MessageTypes.__innerTypesByCode__[unionCode + ''];
			return setValue(obj[1][1], MessageTypes[unionType.className](), MessageTypes);

			function setValue(msgpackData, destObject, MessageTypes) {
				var name = destObject.constructor.name;
				var {values} = MessageTypes.__innerTypes__[name];

				for (var i = values.length - 1; i >= 0; i--) {
					var {valueName, keyCode, type, isArray} = values[i],
						buffer = msgpackData[keyCode];
					if (MessageTypes[type]) {
						destObject[valueName] = isArray 
							? buffer.map(msgpackDataElement => setValue(msgpackDataElement, MessageTypes[type](), MessageTypes))
							: setValue(buffer, MessageTypes[type](), MessageTypes);
					} else {
						destObject[valueName] = buffer;
					}
				}
				return destObject;
			}
		}
		var typedData = parseData(message);

		var serializer = {
			isConnected: true,
			socket: {
				send(data) {
					console.debug(data);
				}
			},
			serialize: function serialize(message) {
				var dataType = message.constructor.name;
				var typeDesc = MessageTypes.__innerTypes__[dataType];
				if (!typeDesc || typeDesc.unionCode < 0) {
					throw `Type MessageTypes.${dataType} is not supported`;
				}
				var msgpackData = [0, [typeDesc.unionCode, []]];
				getValues(message, msgpackData[1][1], MessageTypes);
				return MessagePack.encode(msgpackData);

				function getValues(message, msgpackData, MessageTypes) {
					var {values} = MessageTypes.__innerTypes__[message.constructor.name];
					for (var i = values.length - 1; i >= 0; i--) {
						var {valueName, keyCode, type, isArray} = values[i];
						var value = message[valueName];
						if (MessageTypes[type]) {
							msgpackData[keyCode] = isArray 
								? value.map(message => getValues(message, [], MessageTypes))
								: getValues(value, [], MessageTypes);
						} else {
							msgpackData[keyCode] = value;
						}
					}
					return msgpackData;
				}
			}
		}
		var arr = serializer.serialize(typedData);
		var typedData2 = parseData(arr);
		console.debug(data, arr);
		console.log(JSON.stringify(typedData, null, '\t'), JSON.stringify(typedData2, null, '\t'))
	</script>
</body>
</html>